require 'capistrano'

$:.unshift(File.expand_path('./lib', ENV['rvm_path'])) # Add RVM's lib directory to the load path.
require "rvm/capistrano"                  # Load RVM's capistrano plugin.
require "bundler/capistrano"
set :rvm_ruby_string, 'ruby-1.9.3-p0@salva'
set :rvm_type, :user

set :application, "salva"
set :repository,  "git://github.com/ifunam/salva.git"

set :scm, :git
set :deploy_to, "/home/deployer/rails_apps/#{application}"
set :user, "deployer"
default_run_options[:pty] = true
set :use_sudo, false

role :web, "yourhost.yourdomain.com"                          # Your HTTP server, Apache/etc
role :app, "yourhost.yourdomain.com"                          # This may be the same as your `Web` server
#role :db, "yourdbhost.yourdomain.com", :primary => true # This is where Rails migrations will run


namespace :deploy do
   task :start do ; end
   task :stop do ; end
   task :restart, :roles => :app, :except => { :no_release => true }do
     run "cd #{current_path}; bundle exec compass compile"
     run "cd #{current_path}; bundle exec rake assets:clean"
     run "cd #{current_path}; bundle exec rake barista:brew"
     run "cd #{current_path}; bundle exec rake assets:precompile"
     run "touch #{File.join(current_path,'tmp','restart.txt')}"
   end

  desc "Symlink shared resources on each release"
  task :symlink_shared, :roles => :app do

    shared_config_dir = "#{shared_path}/config"
    unless Dir.exists? shared_config_dir
      run "mkdir -p #{shared_config_dir}"
    end

    %w(database.yml ldap.yml mail.yml site.yml newrelic.yml).each do |config_file|
      config_file_path = File.join(shared_config_dir, config_file)
      unless File.exists? config_file_path
        run "cp #{release_path}/config/#{config_file}.example #{config_file_path}"
      end
      run "ln -nfs #{config_file_path} #{release_path}/config/#{config_file}"
    end

    shared_upload_dir = "#{shared_path}/uploads"
    unless Dir.exists? shared_upload_dir
      run "mkdir -p #{shared_upload_dir}"
    end
    run "ln -nfs #{shared_upload_dir} #{release_path}/public/uploads"

  end
end

before "deploy:restart", "deploy:symlink_shared"